generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////////////////////
// SYSTEM / IAM (KEYCLOAK INTEGRATION)
//////////////////////////////////////////////////
model sys_user {
  id String @id
  keycloak_user_id String @unique
  username String
  email String?
  full_name String?
  phone String?
  avatar_url String?
  status String @default("ACTIVE") // ACTIVE, INACTIVE, BLOCKED

  groups sys_user_group[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model sys_group {
  id String @id // ADMIN, STAFF, SALE
  name String
  description String?
  status String @default("ACTIVE")

  users sys_user_group[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model sys_user_group {
  user_id String
  group_id String

  user sys_user @relation(fields: [user_id], references: [id])
  group sys_group @relation(fields: [group_id], references: [id])

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@id([user_id, group_id])
}

//////////////////////////////////////////////////
// CATALOG – CAR
//////////////////////////////////////////////////
model cm_car_brand {
  id String @id
  name String
  status String @default("ACTIVE")

  models cm_car_model[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model cm_car_model {
  id String @id
  name String
  brand_id String
  status String @default("ACTIVE")

  brand cm_car_brand @relation(fields: [brand_id], references: [id])
  cars cm_car[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([brand_id])
}

model cm_car {
  id String @id
  model_id String
  year Int
  status String @default("AVAILABLE") // AVAILABLE, RESERVED, SOLD

  model cm_car_model @relation(fields: [model_id], references: [id])
  detail cm_car_detail?
  prices cm_price[]
  images cm_car_image[]
  orderItems ord_order_item[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([model_id])
}

model cm_car_detail {
  car_id String @id
  engine String
  transmission String
  fuel_type String
  color String
  seat_capacity Int
  mileage Int
  description String?

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  car cm_car @relation(fields: [car_id], references: [id])
}

model cm_car_image {
  id String @id
  car_id String
  s3_url String
  is_primary Boolean @default(false)

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  car cm_car @relation(fields: [car_id], references: [id])
}

model cm_price {
  id String @id
  car_id String
  price Decimal
  currency String
  valid_from DateTime
  valid_to DateTime?
  status String @default("ACTIVE")

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  car cm_car @relation(fields: [car_id], references: [id])
}

//////////////////////////////////////////////////
// CATALOG – BIKE
//////////////////////////////////////////////////
model cm_bike_brand {
  id String @id
  name String
  status String @default("ACTIVE")

  models cm_bike_model[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model cm_bike_model {
  id String @id
  name String
  brand_id String
  status String @default("ACTIVE")

  brand cm_bike_brand @relation(fields: [brand_id], references: [id])
  bikes cm_bike[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([brand_id])
}

model cm_bike {
  id String @id
  model_id String
  year Int
  status String @default("AVAILABLE") // AVAILABLE, RESERVED, SOLD

  model cm_bike_model @relation(fields: [model_id], references: [id])
  detail cm_bike_detail?
  prices cm_bike_price[]
  images cm_bike_image[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([model_id])
}

model cm_bike_detail {
  bike_id String @id
  engine String
  transmission String
  fuel_type String
  color String
  seat_capacity Int
  mileage Int
  description String?

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  bike cm_bike @relation(fields: [bike_id], references: [id])
}

model cm_bike_image {
  id String @id
  bike_id String
  s3_url String
  is_primary Boolean @default(false)

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  bike cm_bike @relation(fields: [bike_id], references: [id])
}

model cm_bike_price {
  id String @id
  bike_id String
  price Decimal
  currency String
  valid_from DateTime
  valid_to DateTime?
  status String @default("ACTIVE")

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  bike cm_bike @relation(fields: [bike_id], references: [id])
}

//////////////////////////////////////////////////
// CATALOG – MOTO
//////////////////////////////////////////////////
model cm_moto_brand {
  id String @id
  name String
  status String @default("ACTIVE")

  models cm_moto_model[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model cm_moto_model {
  id String @id
  name String
  brand_id String
  status String @default("ACTIVE")

  brand cm_moto_brand @relation(fields: [brand_id], references: [id])
  motos cm_moto[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([brand_id])
}

model cm_moto {
  id String @id
  model_id String
  year Int
  status String @default("AVAILABLE") // AVAILABLE, RESERVED, SOLD

  model cm_moto_model @relation(fields: [model_id], references: [id])
  detail cm_moto_detail?
  prices cm_moto_price[]
  images cm_moto_image[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([model_id])
}

model cm_moto_detail {
  moto_id String @id
  engine String
  transmission String
  fuel_type String
  color String
  seat_capacity Int
  mileage Int
  description String?

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  moto cm_moto @relation(fields: [moto_id], references: [id])
}

model cm_moto_image {
  id String @id
  moto_id String
  s3_url String
  is_primary Boolean @default(false)

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  moto cm_moto @relation(fields: [moto_id], references: [id])
}

model cm_moto_price {
  id String @id
  moto_id String
  price Decimal
  currency String
  valid_from DateTime
  valid_to DateTime?
  status String @default("ACTIVE")

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  moto cm_moto @relation(fields: [moto_id], references: [id])
}

//////////////////////////////////////////////////
// SERVICE & SHIPPING
//////////////////////////////////////////////////
model cm_service {
  id String @id
  name String
  description String?
  base_price Decimal
  currency String
  status String @default("ACTIVE")

  orderServices ord_order_service[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model cm_shipping_method {
  id String @id
  name String
  description String?
  base_fee Decimal
  currency String
  status String @default("ACTIVE")

  shippings ord_shipping[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

//////////////////////////////////////////////////
// ORDER / PAYMENT
//////////////////////////////////////////////////
model ord_customer {
  id String @id
  name String
  phone String
  email String?
  address String?
  status String @default("ACTIVE")

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  orders ord_order[]
}

model ord_order {
  id String @id
  customer_id String
  status String @default("NEW") // NEW, PAID, COMPLETED
  total_amount Decimal
  service_fee Decimal @default(0)
  shipping_fee Decimal @default(0)
  grand_total Decimal
  currency String

  customer ord_customer @relation(fields: [customer_id], references: [id], onDelete: Cascade)
  items ord_order_item[]
  services ord_order_service[]
  payment ord_payment?
  shippings ord_shipping[]
  returns ord_return[]

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@index([customer_id])
}

model ord_order_item {
  id String @id
  order_id String
  car_id String
  price Decimal

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  order ord_order @relation(fields: [order_id], references: [id])
  car cm_car @relation(fields: [car_id], references: [id])
}

model ord_order_service {
  id String @id
  order_id String
  service_id String
  price Decimal

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  order ord_order @relation(fields: [order_id], references: [id])
  service cm_service @relation(fields: [service_id], references: [id])
}

model ord_shipping {
  id String @id
  order_id String
  shipping_method_id String
  delivery_address String
  fee Decimal
  status String @default("PENDING")

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  order ord_order @relation(fields: [order_id], references: [id], onDelete: Cascade)
  method cm_shipping_method @relation(fields: [shipping_method_id], references: [id])

  @@index([order_id])
  @@index([shipping_method_id])
}

model ord_payment {
  id String @id
  order_id String @unique
  provider String
  amount Decimal
  status String @default("PENDING")
  transaction_id String?

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
  
  order ord_order @relation(fields: [order_id], references: [id], onDelete: Cascade)
}

model ord_return {
  id String @id
  order_id String
  reason String
  status String @default("REQUESTED") // REQUESTED, APPROVED, REJECTED, COMPLETED
  refund_amount Decimal
  currency String

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  order ord_order @relation(fields: [order_id], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////
// REVIEWS & INVENTORY
//////////////////////////////////////////////////
model cm_review {
  id String @id
  product_type String // CAR, MOTO, BIKE
  product_id String
  customer_id String
  rating Int // 1-5
  title String?
  content String?
  status String @default("PENDING") // PENDING, APPROVED, REJECTED

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt
}

model cm_inventory {
  id String @id
  product_type String // CAR, MOTO, BIKE
  product_id String
  quantity_total Int
  quantity_reserved Int
  quantity_available Int
  location String?

  created_by String
  created_time DateTime @default(now())
  modified_by String?
  modified_time DateTime @updatedAt

  @@unique([product_type, product_id])
}

//////////////////////////////////////////////////
// REPORT & EVENT
//////////////////////////////////////////////////

model sys_event_log {
  id String @id
  topic String
  payload Json
  status String @default("NEW")
  retry_count Int @default(0)
}
